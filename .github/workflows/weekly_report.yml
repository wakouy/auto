name: Weekly Report

on:
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  report:
    runs-on: ubuntu-latest
    env:
      GA4_SERVICE_ACCOUNT_JSON: ${{ secrets.GA4_SERVICE_ACCOUNT_JSON }}
      GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Write GA credentials (optional)
        if: ${{ env.GA4_SERVICE_ACCOUNT_JSON != '' }}
        run: |
          printf '%s' "$GA4_SERVICE_ACCOUNT_JSON" > /tmp/ga4-sa.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/ga4-sa.json" >> "$GITHUB_ENV"

      - name: Sync yesterday metrics (optional)
        run: |
          set -euxo pipefail
          python -m scripts.sync_ga4_metrics --config config/system.yaml --metrics data/analytics_metrics.csv

      - name: Generate weekly report
        run: |
          set -euxo pipefail
          python -m scripts.weekly_report --config config/system.yaml --reports-dir reports

      - name: Generate Search Console checklist
        run: |
          set -euxo pipefail
          python -m scripts.search_console_checklist --config config/system.yaml --output reports/search-console-checklist.md

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit and push report
        run: |
          if [[ -n "$(git status --porcelain reports/ data/analytics_metrics.csv)" ]]; then
            git add reports/ data/analytics_metrics.csv
            git commit -m "chore: weekly KPI report"
            git pull --rebase origin main
            git push origin HEAD:main
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `Weekly report failed (${new Date().toISOString().slice(0,10)})`;
            const body = [
              'Weekly report workflow failed.',
              '',
              `Run URL: ${runUrl}`,
              `Workflow: ${context.workflow}`,
              `Job: ${context.job}`
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['automation', 'report-failure']
            });
