name: Daily Metrics Sync

on:
  schedule:
    - cron: '40 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      GA4_SERVICE_ACCOUNT_JSON: ${{ secrets.GA4_SERVICE_ACCOUNT_JSON }}
      GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Write GA credentials (optional)
        if: ${{ env.GA4_SERVICE_ACCOUNT_JSON != '' }}
        run: |
          printf '%s' "$GA4_SERVICE_ACCOUNT_JSON" > /tmp/ga4-sa.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/ga4-sa.json" >> "$GITHUB_ENV"

      - name: Sync GA4 daily metrics
        run: |
          set -euxo pipefail
          python -m scripts.sync_ga4_metrics --config config/system.yaml --metrics data/analytics_metrics.csv

      - name: Update monetization dashboard
        run: |
          set -euxo pipefail
          python -m scripts.update_dashboard --config config/system.yaml --site-config _config.yml --tools data/tools.csv --metrics data/analytics_metrics.csv --ad-revenue data/ad_revenue.csv --output-report reports/monetization-dashboard.md --output-site content/dashboard.md

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit and push metrics
        run: |
          if [[ -n "$(git status --porcelain data/analytics_metrics.csv reports/monetization-dashboard.md content/dashboard.md)" ]]; then
            git add data/analytics_metrics.csv reports/monetization-dashboard.md content/dashboard.md
            git commit -m "chore: sync daily analytics metrics"
            git pull --rebase origin main
            git push origin HEAD:main
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `Daily metrics sync failed (${new Date().toISOString().slice(0,10)})`;
            const body = [
              'Daily metrics sync workflow failed.',
              '',
              `Run URL: ${runUrl}`,
              `Workflow: ${context.workflow}`,
              `Job: ${context.job}`
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['automation', 'metrics-failure']
            });
